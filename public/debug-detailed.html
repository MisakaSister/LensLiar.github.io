<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>详细调试工具</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h2 {
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover {
            background: #0056b3;
        }
        .btn-success {
            background: #28a745;
        }
        .btn-danger {
            background: #dc3545;
        }
        .log-area {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 12px;
            margin-top: 10px;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-weight: bold;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        input, textarea {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .step {
            background: #e9ecef;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
        .step h4 {
            margin: 0 0 10px 0;
            color: #495057;
        }
    </style>
</head>
<body>
    <h1>🔍 详细调试工具</h1>
    
    <div class="container">
        <h2>🔐 步骤1: 认证检查</h2>
        <div class="step">
            <h4>检查登录状态</h4>
            <button class="btn" onclick="checkAuth()">检查认证</button>
            <div id="authStatus"></div>
        </div>
        <div id="authLog" class="log-area"></div>
    </div>

    <div class="grid">
        <div class="container">
            <h2>📤 步骤2: 创建测试相册</h2>
            <div class="step">
                <h4>创建相册数据</h4>
                <input type="text" id="albumTitle" placeholder="相册标题" value="调试测试相册">
                <textarea id="albumDesc" placeholder="相册描述">这是一个用于调试的测试相册</textarea>
                <button class="btn btn-success" onclick="createTestAlbum()">创建相册</button>
            </div>
            <div id="createLog" class="log-area"></div>
        </div>

        <div class="container">
            <h2>📥 步骤3: 读取相册数据</h2>
            <div class="step">
                <h4>从不同来源读取</h4>
                <button class="btn" onclick="loadFromAPI()">从管理API读取</button>
                <button class="btn" onclick="loadFromPublicAPI()">从公开API读取</button>
                <button class="btn" onclick="compareData()">对比数据</button>
            </div>
            <div id="loadLog" class="log-area"></div>
        </div>
    </div>

    <div class="container">
        <h2>🔍 步骤4: 详细API调试</h2>
        <div class="step">
            <h4>API端点测试</h4>
            <button class="btn" onclick="testAllEndpoints()">测试所有端点</button>
            <button class="btn" onclick="testKVOperations()">测试KV操作</button>
            <button class="btn btn-danger" onclick="clearAllTestData()">清理测试数据</button>
        </div>
        <div id="apiLog" class="log-area"></div>
    </div>

    <div class="container">
        <h2>📊 步骤5: 数据分析</h2>
        <div id="dataAnalysis"></div>
    </div>

    <script>
        const API_BASE = 'https://api.wengguodong.com';
        let testResults = {
            auth: null,
            create: null,
            load: null,
            publicAPI: null
        };

        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? '❌' : type === 'success' ? '✅' : type === 'warning' ? '⚠️' : '📝';
            element.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            element.scrollTop = element.scrollHeight;
        }

        function setStatus(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        async function checkAuth() {
            const logEl = document.getElementById('authLog');
            logEl.textContent = '';
            
            const token = localStorage.getItem('authToken');
            if (!token) {
                log('authLog', '没有找到登录令牌', 'error');
                setStatus('authStatus', '❌ 未登录', 'error');
                testResults.auth = false;
                return false;
            }
            
            log('authLog', '找到令牌: ' + token.substring(0, 30) + '...');
            
            try {
                // 测试内容API
                const contentResponse = await fetch(`${API_BASE}/content`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                log('authLog', `内容API响应: ${contentResponse.status}`);
                
                // 测试图片API
                const imagesResponse = await fetch(`${API_BASE}/images`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                log('authLog', `图片API响应: ${imagesResponse.status}`);
                
                if (contentResponse.ok && imagesResponse.ok) {
                    log('authLog', '所有API认证成功', 'success');
                    setStatus('authStatus', '✅ 认证成功', 'success');
                    testResults.auth = true;
                    return true;
                } else {
                    log('authLog', '部分API认证失败', 'error');
                    setStatus('authStatus', '❌ 认证失败', 'error');
                    testResults.auth = false;
                    return false;
                }
            } catch (error) {
                log('authLog', '认证检查异常: ' + error.message, 'error');
                setStatus('authStatus', '❌ 认证异常', 'error');
                testResults.auth = false;
                return false;
            }
        }

        async function createTestAlbum() {
            const logEl = document.getElementById('createLog');
            logEl.textContent = '';
            
            if (!testResults.auth) {
                log('createLog', '请先通过认证检查', 'error');
                return;
            }
            
            const title = document.getElementById('albumTitle').value;
            const description = document.getElementById('albumDesc').value;
            
            const albumData = {
                title: title,
                description: description,
                category: '调试分类',
                tags: ['调试', '测试'],
                images: [
                    {
                        url: 'https://picsum.photos/800/600?random=' + Date.now(),
                        fileName: 'debug_test_' + Date.now() + '.jpg',
                        title: '调试测试图片1',
                        alt: '调试测试图片1',
                        caption: '这是调试用的测试图片',
                        size: 1024000,
                        type: 'image/jpeg'
                    },
                    {
                        url: 'https://picsum.photos/800/600?random=' + (Date.now() + 1),
                        fileName: 'debug_test_' + (Date.now() + 1) + '.jpg',
                        title: '调试测试图片2',
                        alt: '调试测试图片2',
                        caption: '这是调试用的测试图片',
                        size: 1024000,
                        type: 'image/jpeg'
                    }
                ]
            };
            
            log('createLog', '准备创建相册...');
            log('createLog', 'API端点: ' + `${API_BASE}/images`);
            log('createLog', '请求数据: ' + JSON.stringify(albumData, null, 2));
            
            try {
                const response = await fetch(`${API_BASE}/images`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    },
                    body: JSON.stringify(albumData)
                });
                
                log('createLog', `响应状态: ${response.status}`);
                log('createLog', `响应头: ${JSON.stringify(Object.fromEntries(response.headers), null, 2)}`);
                
                const responseText = await response.text();
                log('createLog', `响应文本: ${responseText}`);
                
                if (response.ok) {
                    const result = JSON.parse(responseText);
                    log('createLog', '相册创建成功', 'success');
                    log('createLog', '返回数据: ' + JSON.stringify(result, null, 2));
                    testResults.create = result;
                } else {
                    log('createLog', '相册创建失败: ' + responseText, 'error');
                    testResults.create = null;
                }
            } catch (error) {
                log('createLog', '创建相册异常: ' + error.message, 'error');
                testResults.create = null;
            }
        }

        async function loadFromAPI() {
            const logEl = document.getElementById('loadLog');
            logEl.textContent = '';
            
            if (!testResults.auth) {
                log('loadLog', '请先通过认证检查', 'error');
                return;
            }
            
            log('loadLog', '从管理API读取相册...');
            
            try {
                const response = await fetch(`${API_BASE}/images`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('authToken')}` }
                });
                
                log('loadLog', `响应状态: ${response.status}`);
                
                const responseText = await response.text();
                log('loadLog', `响应文本: ${responseText}`);
                
                if (response.ok) {
                    const result = JSON.parse(responseText);
                    log('loadLog', '管理API读取成功', 'success');
                    log('loadLog', `找到 ${result.images ? result.images.length : 0} 个相册`);
                    testResults.load = result;
                } else {
                    log('loadLog', '管理API读取失败: ' + responseText, 'error');
                    testResults.load = null;
                }
            } catch (error) {
                log('loadLog', '管理API读取异常: ' + error.message, 'error');
                testResults.load = null;
            }
        }

        async function loadFromPublicAPI() {
            const logEl = document.getElementById('loadLog');
            
            log('loadLog', '从公开API读取相册...');
            
            try {
                const response = await fetch(`${API_BASE}/api/content`);
                
                log('loadLog', `公开API响应状态: ${response.status}`);
                
                const responseText = await response.text();
                log('loadLog', `公开API响应文本: ${responseText.substring(0, 500)}...`);
                
                if (response.ok) {
                    const result = JSON.parse(responseText);
                    log('loadLog', '公开API读取成功', 'success');
                    log('loadLog', `找到 ${result.images ? result.images.length : 0} 个相册`);
                    testResults.publicAPI = result;
                } else {
                    log('loadLog', '公开API读取失败: ' + responseText, 'error');
                    testResults.publicAPI = null;
                }
            } catch (error) {
                log('loadLog', '公开API读取异常: ' + error.message, 'error');
                testResults.publicAPI = null;
            }
        }

        async function compareData() {
            const logEl = document.getElementById('loadLog');
            
            if (!testResults.load || !testResults.publicAPI) {
                log('loadLog', '请先分别从管理API和公开API读取数据', 'warning');
                return;
            }
            
            log('loadLog', '对比数据...');
            
            const adminAlbums = testResults.load.images || [];
            const publicAlbums = testResults.publicAPI.images || [];
            
            log('loadLog', `管理API: ${adminAlbums.length} 个相册`);
            log('loadLog', `公开API: ${publicAlbums.length} 个相册`);
            
            if (adminAlbums.length === publicAlbums.length) {
                log('loadLog', '数据数量一致', 'success');
            } else {
                log('loadLog', '数据数量不一致', 'warning');
            }
            
            updateDataAnalysis();
        }

        async function testAllEndpoints() {
            const logEl = document.getElementById('apiLog');
            logEl.textContent = '';
            
            const endpoints = [
                { url: `${API_BASE}/auth`, method: 'GET', auth: false },
                { url: `${API_BASE}/content`, method: 'GET', auth: true },
                { url: `${API_BASE}/images`, method: 'GET', auth: true },
                { url: `${API_BASE}/api/content`, method: 'GET', auth: false },
                { url: `${API_BASE}/upload`, method: 'GET', auth: true }
            ];
            
            for (const endpoint of endpoints) {
                try {
                    const headers = {};
                    if (endpoint.auth) {
                        headers['Authorization'] = `Bearer ${localStorage.getItem('authToken')}`;
                    }
                    
                    const response = await fetch(endpoint.url, {
                        method: endpoint.method,
                        headers: headers
                    });
                    
                    log('apiLog', `${endpoint.method} ${endpoint.url}: ${response.status}`);
                } catch (error) {
                    log('apiLog', `${endpoint.method} ${endpoint.url}: ERROR - ${error.message}`, 'error');
                }
            }
        }

        async function testKVOperations() {
            const logEl = document.getElementById('apiLog');
            
            log('apiLog', '测试KV操作...');
            log('apiLog', '注意: 这需要在Worker中添加专门的调试端点');
            
            // 这里可以添加更多KV相关的测试
        }

        async function clearAllTestData() {
            const logEl = document.getElementById('apiLog');
            logEl.textContent = '';
            
            if (!confirm('确定要清理所有测试数据吗？')) {
                return;
            }
            
            if (!testResults.auth) {
                log('apiLog', '请先通过认证检查', 'error');
                return;
            }
            
            // 先获取所有相册
            try {
                const response = await fetch(`${API_BASE}/images`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('authToken')}` }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    const albums = result.images || [];
                    
                    log('apiLog', `找到 ${albums.length} 个相册`);
                    
                    // 删除包含"调试"或"测试"的相册
                    for (const album of albums) {
                        if (album.title.includes('调试') || album.title.includes('测试') || album.category.includes('调试')) {
                            try {
                                const deleteResponse = await fetch(`${API_BASE}/images/${album.id}`, {
                                    method: 'DELETE',
                                    headers: { 'Authorization': `Bearer ${localStorage.getItem('authToken')}` }
                                });
                                
                                if (deleteResponse.ok) {
                                    log('apiLog', `删除相册: ${album.title}`, 'success');
                                } else {
                                    log('apiLog', `删除失败: ${album.title}`, 'error');
                                }
                            } catch (error) {
                                log('apiLog', `删除异常: ${album.title} - ${error.message}`, 'error');
                            }
                        }
                    }
                }
            } catch (error) {
                log('apiLog', '清理数据异常: ' + error.message, 'error');
            }
        }

        function updateDataAnalysis() {
            const container = document.getElementById('dataAnalysis');
            
            let html = '<h3>📊 测试结果分析</h3>';
            
            html += '<div class="step">';
            html += '<h4>认证状态</h4>';
            html += `<p>状态: ${testResults.auth ? '✅ 成功' : '❌ 失败'}</p>`;
            html += '</div>';
            
            html += '<div class="step">';
            html += '<h4>相册创建</h4>';
            html += `<p>状态: ${testResults.create ? '✅ 成功' : '❌ 失败'}</p>`;
            if (testResults.create) {
                html += `<p>相册ID: ${testResults.create.album ? testResults.create.album.id : 'N/A'}</p>`;
            }
            html += '</div>';
            
            html += '<div class="step">';
            html += '<h4>数据读取</h4>';
            html += `<p>管理API: ${testResults.load ? '✅ 成功' : '❌ 失败'}</p>`;
            html += `<p>公开API: ${testResults.publicAPI ? '✅ 成功' : '❌ 失败'}</p>`;
            if (testResults.load && testResults.publicAPI) {
                const adminCount = testResults.load.images ? testResults.load.images.length : 0;
                const publicCount = testResults.publicAPI.images ? testResults.publicAPI.images.length : 0;
                html += `<p>数据一致性: ${adminCount === publicCount ? '✅ 一致' : '❌ 不一致'}</p>`;
            }
            html += '</div>';
            
            container.innerHTML = html;
        }

        // 页面加载时自动检查认证
        window.onload = function() {
            checkAuth();
        };
    </script>
</body>
</html> 